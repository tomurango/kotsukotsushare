# chokushii プロジェクト開発指針

## プロジェクト概要
- **サービス名**: chokushii (チョクシー)
- **コンセプト**: セルフリフレクション・習慣追跡アプリ
- **技術スタック**: Flutter + Firebase (Firestore, Functions, Auth)

## 開発方針

### 現在のchokushiiプロジェクト
- **主要機能**: カードメモ、質問掲示板、AI相談、内省機能
- **アーキテクチャ**: Firebase中心のクラウドファースト設計
- **今後の方針**: 
  - UIの調整・改善は継続実施
  - 既存機能の維持・バグ修正は継続
  - **思い出すことを主目的とする大幅な機能改修は実施しない**

### 新プロジェクト「オモイダシ」への分離
2024年7月に以下の理由により、思い出し機能に特化した新サービス「オモイダシ」を別プロジェクトとして開発することを決定：

**分離理由:**
- ユーザーニーズの違い: 内省・成長 vs 記憶・想起
- 技術アーキテクチャの違い: クラウドファースト vs ローカルファースト  
- UI/UX設計の違い: カード中心 vs メモ一覧中心

**chokushiiの今後:**
- 現在の内省・成長フォーカスを維持
- Firebase基盤の既存アーキテクチャを継続
- コミュニティ機能（質問掲示板）やAI相談機能を活かした発展

**オモイダシの位置づけ:**
- chokushiiの兄弟サービス
- 「大切な考えを忘れない」ことに特化
- ローカルファースト・シンプル設計

## 技術的な注意事項

### テスト・ビルドコマンド
```bash
# プロジェクトのテスト・ビルドコマンドが特定されている場合は、ここに記載
# 現在は標準的なFlutterコマンドを使用
flutter test
flutter build apk
flutter build ios
```

### データ構造
- **Firestore構造**: `/users/{userId}/cards/{cardId}/memos/{memoId}`
- **主要モデル**: `MemoData`, `PublicMemoData`, `CardData`
- **セキュリティ**: ユーザー単位でのアクセス制御

### 既存機能の保持
- カードメモ機能
- 質問掲示板機能
- AI相談機能（Vertex AI連携）
- ブロック・報告機能
- プレミアム機能（RevenueCat）

## 検討中の修正方針（2025年9月）

### 1. 質問掲示板のお金の流れの見直し
- 現在のマネタイズ方法の再検討
- 課金体系の最適化

### 2. ホーム画面データのローカル移行 ✅ **実装完了**
- 現在のFirestore中心からローカルファーストへの段階的移行
- 既存ユーザー向けのデータ移行機能の実装
- 移行操作UIの提供

### 3. 質問掲示板マネタイズ機能 ✅ **実装完了**
- 回答者還元システムの実装
- 課金オプション付き質問投稿機能
- ベストアンサー選択による報酬分配システム

## 実装済み機能（2025年9月18日）

### ホーム画面ローカル移行機能
**実装内容:**
- SQLite（sqflite）ベースのローカルデータベース設定
- カード・メモデータの完全ローカル保存
- Firestore ↔ ローカル統合プロバイダー
- データ移行サービス（進捗表示・エラーハンドリング付き）
- 設定画面からアクセス可能な移行UI

**新規ユーザーのデフォルト動作:**
- データ未保存の新規ユーザー → 自動的にローカルデータ使用
- 既存データありの既存ユーザー → デフォルトはクラウド使用（任意移行）
- SharedPreferencesによる設定永続化

**移行制限:**
- 一度移行完了したユーザーはクラウドに戻せない制限
- 移行完了フラグ（`migration_completed_{userId}`）で管理
- UI上で復帰ボタン非表示・エラーメッセージ表示

**データ分離:**
- **ローカル化対象**: カードメモデータ（高速化・プライバシー向上）
- **クラウド継続**: 質問掲示板、AI相談、認証・決済

### 依存関係の追加
```yaml
dependencies:
  sqflite: ^2.3.0
  path: ^1.8.3
  shared_preferences: ^2.2.0
```

### 新規ファイル
- `lib/src/services/local_database.dart` - SQLiteデータベース管理
- `lib/src/providers/local_data_provider.dart` - ローカルデータプロバイダー
- `lib/src/services/migration_service.dart` - データ移行サービス
- `lib/src/screens/data_migration_screen.dart` - 移行UI画面

### 質問掲示板マネタイズ機能（2025年9月19日追加）
**実装内容:**
- 3段階課金システム（基本100円、優先300円、緊急500円）
- 課金額の60%を回答者に還元する報酬システム
- ベストアンサー選択機能（質問者による）
- ローカルデータベースでの課金・報酬履歴管理

**新規データベーステーブル:**
- `question_payments` - 質問課金履歴
- `answer_rewards` - 回答報酬履歴
- `reward_withdrawals` - 報酬引き出し履歴

**新規画面:**
- 質問投稿時の課金オプション選択UI
- ベストアンサー選択ボタン（回答表示画面）
- 報酬管理画面（設定から遷移）
- 課金履歴画面（報酬管理から遷移）

**Cloud Functions:**
- `selectBestAnswer` - ベストアンサー選択処理
- `getAnswers` - 回答取得（ベストアンサー情報含む）

**報酬分配:**
- 質問者課金 → 60%が回答者報酬、40%がプラットフォーム収益
- 報酬ステータス管理（pending/paid/cancelled）

**実装状況:**
- ✅ 基本機能実装完了（2025年9月19日）
- ⏳ **動作確認待ち** - 実装完了後の動作テストを実施予定
- ⏳ 動作確認完了後に今後の進行方針を検討予定

### AI相談機能について
- **現在の状態**: ローカル使用時でも利用可能（メッセージ履歴はFirestore保存）
- **削除予定**: AI相談機能は将来的に削除予定
- **将来方針**: AI相談履歴のローカル移管（読み取り専用）を検討

---
*最終更新: 2025年9月19日*