# chokushii プロジェクト開発指針

## プロジェクト概要
- **サービス名**: chokushii (チョクシー)
- **コンセプト**: セルフリフレクション・習慣追跡アプリ
- **技術スタック**: Flutter + Firebase (Firestore, Functions, Auth)

## 開発方針

### 現在のchokushiiプロジェクト
- **主要機能**: カードメモ、質問掲示板、AI相談、内省機能
- **アーキテクチャ**: Firebase中心のクラウドファースト設計
- **今後の方針**: 
  - UIの調整・改善は継続実施
  - 既存機能の維持・バグ修正は継続
  - **思い出すことを主目的とする大幅な機能改修は実施しない**

### 新プロジェクト「オモイダシ」への分離
2024年7月に以下の理由により、思い出し機能に特化した新サービス「オモイダシ」を別プロジェクトとして開発することを決定：

**分離理由:**
- ユーザーニーズの違い: 内省・成長 vs 記憶・想起
- 技術アーキテクチャの違い: クラウドファースト vs ローカルファースト  
- UI/UX設計の違い: カード中心 vs メモ一覧中心

**chokushiiの今後:**
- 現在の内省・成長フォーカスを維持
- Firebase基盤の既存アーキテクチャを継続
- コミュニティ機能（質問掲示板）やAI相談機能を活かした発展

**オモイダシの位置づけ:**
- chokushiiの兄弟サービス
- 「大切な考えを忘れない」ことに特化
- ローカルファースト・シンプル設計

## 技術的な注意事項

### テスト・ビルドコマンド
```bash
# プロジェクトのテスト・ビルドコマンドが特定されている場合は、ここに記載
# 現在は標準的なFlutterコマンドを使用
flutter test
flutter build apk
flutter build ios
```

### データ構造
- **Firestore構造**: `/users/{userId}/cards/{cardId}/memos/{memoId}`
- **主要モデル**: `MemoData`, `PublicMemoData`, `CardData`
- **セキュリティ**: ユーザー単位でのアクセス制御

### 既存機能の保持
- カードメモ機能
- 質問掲示板機能
- AI相談機能（Vertex AI連携）
- ブロック・報告機能
- プレミアム機能（RevenueCat）

## 検討中の修正方針（2025年9月）

### 1. 質問掲示板のお金の流れの見直し
- 現在のマネタイズ方法の再検討
- 課金体系の最適化

### 2. ホーム画面データのローカル移行 ✅ **実装完了**
- 現在のFirestore中心からローカルファーストへの段階的移行
- 既存ユーザー向けのデータ移行機能の実装
- 移行操作UIの提供

### 3. 質問掲示板マネタイズ機能 ✅ **実装完了**
- 回答者還元システムの実装
- 課金オプション付き質問投稿機能
- ベストアンサー選択による報酬分配システム

## 実装済み機能（2025年9月18日）

### ホーム画面ローカル移行機能
**実装内容:**
- SQLite（sqflite）ベースのローカルデータベース設定
- カード・メモデータの完全ローカル保存
- Firestore ↔ ローカル統合プロバイダー
- データ移行サービス（進捗表示・エラーハンドリング付き）
- 設定画面からアクセス可能な移行UI

**新規ユーザーのデフォルト動作:**
- データ未保存の新規ユーザー → 自動的にローカルデータ使用
- 既存データありの既存ユーザー → デフォルトはクラウド使用（任意移行）
- SharedPreferencesによる設定永続化

**移行制限:**
- 一度移行完了したユーザーはクラウドに戻せない制限
- 移行完了フラグ（`migration_completed_{userId}`）で管理
- UI上で復帰ボタン非表示・エラーメッセージ表示

**データ分離:**
- **ローカル化対象**: カードメモデータ（高速化・プライバシー向上）
- **クラウド継続**: 質問掲示板、AI相談、認証・決済

### 依存関係の追加
```yaml
dependencies:
  sqflite: ^2.3.0
  path: ^1.8.3
  shared_preferences: ^2.2.0
```

### 新規ファイル
- `lib/src/services/local_database.dart` - SQLiteデータベース管理
- `lib/src/providers/local_data_provider.dart` - ローカルデータプロバイダー
- `lib/src/services/migration_service.dart` - データ移行サービス
- `lib/src/screens/data_migration_screen.dart` - 移行UI画面

### 質問掲示板マネタイズ機能 🔄 **設計変更中**

#### 旧設計（2025年9月19日、廃止予定）
- 3段階課金システム（質問投稿時課金）
- 質問単位プールでの即時分配
- ⚠️ **以下の理由により設計変更**:
  - App Store/Google Play審査リスク（IAP未使用）
  - 貢献度（ベストアンサー）反映の不完全さ
  - スケーラビリティの問題

#### 新設計（2025年10月改訂、実装予定）
**基本方針:**
- **月次グローバルプール方式** - 公平性と法的安全性の両立
- **IAP（In-App Purchase）導入** - App Store/Google Play規約遵守
- **質問アンロック課金** - 質問投稿は無料、回答閲覧時に課金

**料金設計（確定）:**
```
質問アンロック: 160円（App Store最低価格に合わせて統一）
  ├─ Apple/Google手数料 30% = 48円
  └─ 残り112円
      ├─ 月次プール 60% = 67円（回答者報酬）
      └─ プラットフォーム 40% = 45円
```

**価格設定の原則:**
- App StoreとGoogle Playで同一料金を維持（必須）
- App Store最低価格（160円）に合わせる
- 将来的な調整の可能性あり

**月次プールの仕組み:**
```
10月1日〜31日:
  - ユーザーが質問をアンロック（160円） → 10月プールに67円蓄積
  - 回答を投稿 → 10月貢献度 +1ポイント
  - ベストアンサー選択 → 10月貢献度 +5ポイント

11月1日 00:00（Cloud Scheduler自動実行）:
  - 10月プール総額 × 各ユーザーの10月ポイント割合 → 報酬分配
  - 10月データを確定（distributed: true）
```

**貢献度ポイント:**
- 基本ポイント: 1ポイント/回答
- ベストアンサーボーナス: +5ポイント
- 例: 通常回答10件 + ベストアンサー1件 = 10 + (1+5) = 16ポイント

**Firestore構造:**
```
monthly_pools/{period}/
  - period: "2025-10"
  - pool_amount: 67000 (例: 1000アンロック × 67円)
  - distributed: false
  - distributed_at: null

monthly_contributions/{period}/{userId}/
  - user_id: "user123"
  - total_points: 16
  - answer_count: 11
  - best_answer_count: 1
  - answers: [answerId1, answerId2, ...]

answer_rewards/{rewardId}/
  - period: "2025-10"
  - user_id: "user123"
  - reward_amount: 4187 (例: 67000 × 16/256)
  - contribution_points: 16
  - status: "pending"
  - created_at: timestamp
```

**法的考慮事項:**
- **資金決済法**: 小規模（月間プール100万円以下）なら届出不要
  - 1000万円超で財務局届出義務
  - 3000万円超で供託義務（違反時: 罰金・懲役）
- **IAP必須**: デジタルコンテンツのアンロックはApp Store/Google Play規約により必須
- **税務処理**: 報酬支払調書（年間5万円超）、源泉徴収の検討が必要

**UI/UX変更:**
- 質問投稿: 無料、匿名、「事務局に送る」表現で心理的ハードル軽減
- 質問閲覧: プレビュー表示（50文字）→ アンロックボタン（160円）
- 回答閲覧: アンロック後、その質問のすべての回答が閲覧可能
- ベストアンサー選択: 質問者のみ可能、月次貢献度に+5ポイント（次月分配）

**段階的リリース戦略:**

**フェーズ1: 無料検証期間（実装中）**
目的: 本番に近いUXでビジネスモデルとユーザー行動を検証

実装内容:
- 本番と同じUI/UXフロー（課金ボタン、引き出しボタンなど）
- 「テスト期間中のため無料」の明示的な表示
- 実際のデータ記録（is_test: true フラグ付き）
- 仮想プール・報酬の計算と表示

具体的な実装:
1. **質問アンロックフロー（無料）**
   - アンロックボタン表示「160円でアンロック」
   - 確認ダイアログ:「⚠️ 現在はテスト期間中のため無料です」
   - [無料でアンロック] ボタン
   - アンロック記録（amount: 160, is_test: true）
   - 仮想プールに67円加算

2. **月次貢献度・報酬計算**
   - 回答投稿 → +1pt記録
   - ベストアンサー選択 → +5pt記録
   - 月次集計処理（Cloud Scheduler）
   - 仮想報酬計算・表示

3. **報酬引き出しフロー（テスト）**
   - 報酬管理画面に獲得予定報酬表示
   - 引き出しボタン → 銀行口座入力画面
   - 「⚠️ テスト期間中のため実際の振込は行われません」
   - 引き出しリクエスト記録（status: "test"）

検証項目:
- 質問閲覧→アンロックの転換率
- 回答投稿頻度
- ベストアンサー選択率
- プール総額とユーザー数から算出される1人あたり報酬額
- Firebase運用コスト
- UXの分かりやすさ

**フェーズ2: 本番課金導入（未定）**
- IAP（In-App Purchase）実装
- 実際の課金処理
- 実際の報酬振込（銀行連携）
- is_testフラグの削除

**実装タスク（フェーズ1）:** ✅ **完了（2025年10月27日）**
- [x] 既存の質問単位プール削除（contribution_pools, answer_unlocks等）
- [x] 月次プール・貢献度記録システム実装
  - [x] monthly_pools コレクション
  - [x] monthly_contributions コレクション
  - [x] answer_rewards コレクション（月次分配用に完全リライト）
  - [x] reward_withdrawals コレクション
  - [x] question_unlocks テーブル（is_testカラム追加、v4）
- [x] Cloud Functions更新
  - [x] unlockQuestion（無料、テストフラグ付き記録）
  - [x] 回答投稿時の貢献度記録（addAnswer.js）
  - [x] selectBestAnswer（貢献度+5pt、報酬分配削除）
  - [x] distributeMonthlyRewards（月次集計・自動分配）
- [x] Cloud Scheduler設定（毎月1日 00:00 JST）
- [x] UI実装
  - [x] 質問アンロックボタン・ダイアログ（テスト表示）
  - [x] 報酬管理画面（貢献度・仮想報酬表示）
  - [x] 報酬引き出し画面（テスト表示、銀行情報入力フォーム）
- [x] データモデル
  - [x] MonthlyPoolData
  - [x] MonthlyContributionData
  - [x] QuestionUnlockData（is_test追加）
  - [x] AnswerRewardData（完全リライト、月次用）
  - [x] RewardWithdrawalData

**次のステップ:**
- 動作テスト・デバッグ
- ユーザーフィードバック収集
- フェーズ2（本番課金）への移行判断

### AI相談機能について
- **現在の状態**: ローカル使用時でも利用可能（メッセージ履歴はFirestore保存）
- **削除予定**: AI相談機能は将来的に削除予定
- **将来方針**: AI相談履歴のローカル移管（読み取り専用）を検討

---
*最終更新: 2025年10月27日*